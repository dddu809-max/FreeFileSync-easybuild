name: Build FreeFileSync for Ubuntu 22.04

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            g++-12 \
            libssl-dev \
            libpsl-dev \
            libidn2-dev \
            libssh2-1-dev \
            libcurl4-openssl-dev \
            libboost-all-dev \
            libgtk2.0-dev \  # 仅保留GTK2，移除GTK3避免冲突
            libglib2.0-dev \
            libsm-dev \
            zlib1g-dev

      - name: Build wxWidgets 3.1.2 (static, no exceptions)
        run: |
          wget https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.2/wxWidgets-3.1.2.tar.bz2
          tar xf wxWidgets-3.1.2.tar.bz2
          cd wxWidgets-3.1.2
          mkdir build-gtk
          cd build-gtk
          ../configure --disable-shared --disable-exceptions
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig

      - name: Tweak source code for libssh2 and libcurl compatibility
        run: |
          # 修复curl_wrap.h中的兼容性问题
          sed -i '78s/^/\/\//' FreeFileSync/Source/afs/libcurl/curl_wrap.h
          sed -i '120s/^/\/\//' FreeFileSync/Source/afs/libcurl/curl_wrap.h

          # 修复sftp.cpp中的宏定义缺失
          sed -i '58i #define MAX_SFTP_OUTGOING_SIZE 30000\n#define MAX_SFTP_READ_SIZE 30000' FreeFileSync/Source/afs/sftp.cpp
          sed -i '1662i #define LIBSSH2_SFTP_DEFAULT_MODE      -1' FreeFileSync/Source/afs/sftp.cpp

          # 调整C++标准为c++2a（兼容FreeFileSync 10.12）
          sed -i 's/-std=c++23/-std=c++2a/' FreeFileSync/Source/Makefile

      - name: Check Resources.zip exists
        run: |
          if [ ! -f "FreeFileSync/Build/Resources.zip" ]; then
            echo "Error: Resources.zip not found in FreeFileSync/Build"
            exit 1
          fi

      - name: Build FreeFileSync
        working-directory: FreeFileSync/Source
        env:
          CXX: g++-12
        run: |
          make -j"$(nproc)"
          echo "Build output:"
          ls -R ../Build || true

      - name: Upload Linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreeFileSync-linux
          path: FreeFileSync/Build/Bin
