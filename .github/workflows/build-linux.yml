name: Build FreeFileSync for Ubuntu 22.04

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  # 也可以手动点按钮触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libpsl-dev \
            libidn2-dev \
            libssh2-1-dev \
            libcurl4-openssl-dev \
            libboost-all-dev \
            libgtk2.0-dev \
            libgtk-3-dev \
            libglib2.0-dev \
            libsm-dev \
            zlib1g-dev

      - name: Build wxWidgets 3.3.1 (static)
        run: |
          wget https://github.com/wxWidgets/wxWidgets/releases/download/v3.3.1/wxWidgets-3.3.1.tar.bz2
          tar xf wxWidgets-3.3.1.tar.bz2
          cd wxWidgets-3.3.1
          mkdir build-gtk
          cd build-gtk
          # 静态库 + 默认是 Unicode，不用特别开
          ../configure --disable-shared
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig

      - name: Build FreeFileSync
        working-directory: FreeFileSync/Source
        env:
          CXXFLAGS: "-std=c++2a"
        run: |
          make -j"$(nproc)"
          echo "Build output:"
          ls -R ../Build || true

      - name: Upload Linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreeFileSync-linux
          path: FreeFileSync/Build/Bin
